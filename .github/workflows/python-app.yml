name: Market Cycle Runner (Parallel + Commit)

on:
  schedule:
    - cron: "*/5 3-10 * * 1-5"   # Every 5 min, Monâ€“Fri
  workflow_dispatch:

env:
  TZ: Asia/Kolkata

concurrency:
  group: market-cycle
  cancel-in-progress: false

jobs:
  # ==========================================
  # JOB 1: INDEX (RUN FIRST)
  # ==========================================
  index_job:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Market Time Check
        run: |
          NOW=$(date +%H%M)
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1545" ]; then
            echo "â›” Outside market hours"
            exit 0
          fi

      - name: Prepare folders
        run: |
          mkdir -p parquet/index parquet/fno logs

      - name: Run Index Script
        run: python DCSEC_BROAD.py

  # ==========================================
  # JOB 2: FNO (PARALLEL)
  # ==========================================
  fno_parallel:
    needs: index_job
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        script:
          - DCFNO1.py
          - DCFNO2.py
          - DCFNO3.py
          - DCFNO4.py
          - DCFNO5.py
          - DCFNO6.py
          - DCFNO7.py
          - DCFNO8.py
          - DCFNO9.py
          - DCFNO10.py
          - DCFNO11.py

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Market Time Check
        run: |
          NOW=$(date +%H%M)
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1545" ]; then
            echo "â›” Outside market hours"
            exit 0
          fi

      - name: Prepare folders
        run: |
          mkdir -p parquet/fno logs

      - name: Run FNO Script
        run: python ${{ matrix.script }}

  # ==========================================
  # JOB 3: COMMIT & PUSH (AFTER ALL FINISH)
  # ==========================================
  commit_push:
    needs: fno_parallel
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Commit & Push Market Data
        run: |
          git config user.name "market-bot"
          git config user.email "market-bot@users.noreply.github.com"

          git add parquet logs || true
          git diff --cached --quiet && echo "No changes" && exit 0

          git commit -m "ðŸ“Š Market data update $(date '+%Y-%m-%d %H:%M IST')"
          git push
