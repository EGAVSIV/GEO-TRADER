name: Market Cycle Runner (Index + Parallel FNO + Commit + Restart)

on:
  schedule:
    # Every 5 minutes, Mondayâ€“Friday (IST 9:00â€“15:45)
    - cron: "*/5 3-10 * * 1-5"
  workflow_dispatch:

env:
  TZ: Asia/Kolkata
  GIT_SHA: ${{ github.sha }}

# Prevent overlapping cycles
concurrency:
  group: market-cycle
  cancel-in-progress: false

jobs:
  # =====================================================
  # JOB 1: INDEX + SECTOR (RUN FIRST)
  # =====================================================
  index_job:
    name: Index Collector
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo (Exact Commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_SHA }}
          fetch-depth: 1
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Market Time Check (IST)
        run: |
          NOW=$(date +%H%M)
          echo "Current IST Time: $NOW"
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1545" ]; then
            echo "â›” Outside market hours"
            exit 0
          fi

      - name: Prepare Folders
        run: |
          mkdir -p parquet/index logs

      - name: Run Index Script
        run: |
          python DCSEC_BROAD.py

  # =====================================================
  # JOB 2: FNO â€” ONE SCRIPT = ONE WORKER (PARALLEL)
  # =====================================================
  fno_parallel:
    name: FNO Worker - ${{ matrix.script }}
    needs: index_job
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        script:
          - DCFNO1.py
          - DCFNO2.py
          - DCFNO3.py
          - DCFNO4.py
          - DCFNO5.py
          - DCFNO6.py
          - DCFNO7.py
          - DCFNO8.py
          - DCFNO9.py
          - DCFNO10.py
          - DCFNO11.py

    steps:
      - name: Checkout Repo (Exact Commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_SHA }}
          fetch-depth: 1
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Market Time Check (IST)
        run: |
          NOW=$(date +%H%M)
          echo "Current IST Time: $NOW"
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1545" ]; then
            echo "â›” Outside market hours"
            exit 0
          fi

      - name: Prepare Folders
        run: |
          mkdir -p parquet/fno logs

      - name: Run FNO Script
        run: |
          echo "â–¶ Running ${{ matrix.script }}"
          python ${{ matrix.script }}

  # =====================================================
  # JOB 3: COMMIT & PUSH DATA
  # =====================================================
  commit_push:
    name: Commit & Push Market Data
    needs: fno_parallel
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo (Exact Commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_SHA }}
          fetch-depth: 1
          persist-credentials: true

      - name: Commit and Push
        run: |
          git config user.name "market-bot"
          git config user.email "market-bot@users.noreply.github.com"

          git add parquet logs || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "ðŸ“Š Market data update $(date '+%Y-%m-%d %H:%M IST')"
          git push

  # =====================================================
  # JOB 4: WAIT 5 SECONDS & RESTART WORKFLOW
  # =====================================================
  restart_workflow:
    name: Restart Workflow After 5 Seconds
    needs: commit_push
    runs-on: ubuntu-latest

    steps:
      - name: Wait 5 seconds
        run: sleep 5

      - name: Trigger workflow again
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_FILE: market-cycle.yml
          REF: main
        run: |
          curl -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches \
            -d "{\"ref\":\"$REF\"}"
