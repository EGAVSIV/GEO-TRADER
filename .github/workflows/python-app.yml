name: Market Automation - One File One Worker (IST)

on:
  schedule:
    - cron: "*/5 3-10 * * 1-5"   # 9:00–4:00 IST Mon–Fri
  workflow_dispatch:

env:
  TZ: Asia/Kolkata

jobs:
  # =====================================================
  # JOB 1: BROAD + SECTOR (RUN FIRST)
  # =====================================================
  broad_sector:
    name: Broad & Sector Index
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Market Hour Check (IST)
        run: |
          NOW=$(date +%H%M)
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1600" ]; then
            echo "⛔ Outside Market Hours"
            exit 0
          fi

      - name: Run Broad / Sector Script
        run: |
          python DCSEC_BROAD.py

  # =====================================================
  # JOB 2: FNO — ONE FILE = ONE WORKER
  # =====================================================
  fno_workers:
    name: FNO Worker - ${{ matrix.script }}
    needs: broad_sector
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        script:
          - DCFNO1.py
          - DCFNO2.py
          - DCFNO3.py
          - DCFNO4.py
          - DCFNO5.py
          - DCFNO6.py
          - DCFNO7.py
          - DCFNO8.py
          - DCFNO9.py
          - DCFNO10.py
          - DCFNO11.py

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Market Hour Check (IST)
        run: |
          NOW=$(date +%H%M)
          if [ "$NOW" -lt "0900" ] || [ "$NOW" -gt "1600" ]; then
            echo "⛔ Outside Market Hours"
            exit 0
          fi

      - name: Run FNO Script
        run: |
          echo "▶ Running ${{ matrix.script }}"
          python ${{ matrix.script }}
